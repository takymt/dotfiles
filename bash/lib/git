function _find_repo_with() {
  local root src
  root="$(ghq root)"
  src="$(ghq list | fzf --preview "tree -L 2 $root/{}")"

  [[ -n "$src" ]] && "$@" "$(ghq root)/$src"
}

function find_repo_with_cd() {
  _find_repo_with cd
}

function find_repo_with_claude() {
  _find_repo_with claude
}

function find_repo_with_vscode() {
  _find_repo_with code
}

function _find_pr_with() {
  local pr
  pr="$(gh pr list | fzf --header-lines=1 | awk '{print $1}')"

  [[ -n "$pr" ]] && gh pr "$@" "$pr"
}

function find_pr_with_checkout() {
  _find_pr_with checkout
}

function find_pr_with_diff() {
  _find_pr_with diff
}

function init_github_repo() {
  read -rp "Repository name: " name
  read -rp "Description: " description

  if [ -z "$name" ]; then
    echo "Repository name is required" >&2
    return 1
  fi

  local cwd
  cwd=$(pwd)

  mkdir -p "$name"
  cd "$name" || return 1

  git init
  git branch -m main

  echo "# $name" >README.md
  git add README.md
  git commit -m "Initial commit"

  gh repo create "$name" \
    --description "$description" \
    --source=. \
    --remote=origin \
    --push

  cd "$cwd" || return 1
}

function generate_gitignore() {
  local input_file="${1:-.gitignore}"

  local selected
  selected=$(gibo list | fzf --multi --preview "gibo dump {}") || return 1

  [[ -z "$selected" ]] && return 1

  while IFS= read -r template; do
    if [[ -s "$input_file" ]]; then
      printf '\n' >>"$input_file"
    fi
    gibo dump "$template" >>"$input_file"
  done <<<"$selected"
}

function fork_repo() {
  if [[ -z "$1" ]]; then
    echo "Usage: fork_repo <github-url>" >&2
    return 1
  fi

  local upstream_url="$1"

  local fork_url
  fork_url=$(gh repo fork "$upstream_url" --clone=false 2>&1 | grep -o 'https://github.com/[^[:space:]]*' | head -1)

  if [[ -z "$fork_url" ]]; then
    echo "Failed to fork repository" >&2
    return 1
  fi

  ghq clone "$fork_url"

  local repo_path
  repo_path=$(ghq list -p | grep -E "$(basename "$fork_url" .git)$" | head -1)

  if [[ -n "$repo_path" ]]; then
    git -C "$repo_path" remote add upstream "$upstream_url"
    echo "Cloned to: $repo_path"
    echo "origin: $fork_url"
    echo "upstream: $upstream_url"
  fi
}

function cd_repo_root() {
  cd "$(git rev-parse --show-toplevel)" || return
}

# function aliases
alias g="find_repo_with_cd"
alias gclaude="find_repo_with_claude"
alias gcode="find_repo_with_vscode"
alias prco="find_pr_with_checkout"
alias prdiff="find_pr_with_diff"
alias ghinit="init_github_repo"
alias ghfork="fork_repo"
alias genignore="generate_gitignore"
alias grt="cd_repo_root"

# git command aliases
alias gs="git status"
alias gl="git log"
alias glo="git log --oneline"
alias gco="git checkout"
alias gc="git commit"
alias ga="git add"
alias gaa="git add -A"
alias gss="git stash save -u"
alias gp="git push"
alias gpl="git pull"
alias gm="git merge"
alias gsp="git stash pop"
alias gb="git branch"

# library aliases
alias lg="lazygit"
